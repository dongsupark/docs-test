<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Customizing the SSH daemon - Flatcar Container Linux Documentation</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../..">Flatcar Container Linux Documentation</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                <!--Only display pages not under the hidden tag in mkdocs.yml-->
                        <li >
                            <a href="../..">Home</a>
                        </li>
                <!--Only display pages not under the hidden tag in mkdocs.yml-->
                        <li >
                            <a href="../quickstart/">Quick start</a>
                        </li>
                <!--Only display pages not under the hidden tag in mkdocs.yml-->
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Navigation <b class="caret"></b></a>
                            <ul class="dropdown-menu">
                                
  <li class="dropdown-submenu">
    <a href="#">Provisioning</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../provisioning/">Using Container Linux Config</a>
</li>
            
<li >
    <a href="../../container-linux-config-transpiler/doc/overview/">Using Config Transpiler</a>
</li>
            
<li >
    <a href="../../container-linux-config-transpiler/doc/dynamic-data/">CL Config Dynamic Data</a>
</li>
            
<li >
    <a href="../../container-linux-config-transpiler/doc/examples/">CL Config Examples</a>
</li>
            
<li >
    <a href="../../container-linux-config-transpiler/doc/configuration/">CL Config Spec</a>
</li>
    </ul>
  </li>
                                
  <li class="dropdown-submenu">
    <a href="#">Cloud Providers</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../booting-on-ec2/">Amazon EC2</a>
</li>
            
<li >
    <a href="../booting-on-azure/">Azure</a>
</li>
            
<li >
    <a href="../booting-on-digitalocean/">Digital Ocean</a>
</li>
            
<li >
    <a href="../booting-on-google-compute-engine/">Google Compute Engine</a>
</li>
            
<li >
    <a href="../booting-with-qemu/">QEMU</a>
</li>
    </ul>
  </li>
                                
  <li class="dropdown-submenu">
    <a href="#">Bare Metal</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../booting-with-ipxe/">Booting with iPXE</a>
</li>
            
<li >
    <a href="../booting-with-pxe/">Booting with PXE</a>
</li>
            
<li >
    <a href="../installing-to-disk/">Installing to Disk</a>
</li>
            
<li >
    <a href="../booting-with-iso/">Booting from ISO</a>
</li>
            
<li >
    <a href="../root-filesystem-placement/">Root filesystem placement</a>
</li>
    </ul>
  </li>
                                
  <li class="dropdown-submenu">
    <a href="#">Migrating from CoreOS Container Linux</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../migrate-from-container-linux/">Migrating from CoreOS Container Linux</a>
</li>
            
<li >
    <a href="../update-from-container-linux/">Updating from CoreOS Container Linux</a>
</li>
    </ul>
  </li>
                                
  <li class="dropdown-submenu">
    <a href="#">Working with Clusters</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">Creating Clusters</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../cluster-architectures/">Cluster architectures</a>
</li>
            
<li >
    <a href="../update-strategies/">Update strategies</a>
</li>
            
<li >
    <a href="../cluster-discovery/">Clustering machines</a>
</li>
            
<li >
    <a href="../verify-images/">Verify Flatcar Container Linux Images with GPG</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Customizing Clusters</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../network-config-with-networkd/">Using networkd to customize networking</a>
</li>
            
<li >
    <a href="../using-systemd-drop-in-units/">Using systemd drop-in units</a>
</li>
            
<li >
    <a href="../using-environment-variables-in-systemd-units/">Using environment variables in systemd units</a>
</li>
            
<li >
    <a href="../configuring-dns/">Configuring DNS</a>
</li>
            
<li >
    <a href="../configuring-date-and-timezone/">Configuring date & timezone</a>
</li>
            
<li >
    <a href="../adding-users/">Adding users</a>
</li>
            
<li >
    <a href="../other-settings/">Kernel modules / sysctl parameters</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Scaling Clusters</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../adding-disk-space/">Adding disk space</a>
</li>
            
<li >
    <a href="../mounting-storage/">Mounting storage</a>
</li>
            
<li >
    <a href="../power-management/">Power management</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Managing Clusters</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../registry-authentication/">Registry authentication</a>
</li>
            
<li >
    <a href="../iscsi/">iSCSI configuration</a>
</li>
            
<li >
    <a href="../adding-swap/">Adding swap</a>
</li>
            
<li >
    <a href="../booting-on-ecs/">Amazon EC2 Container Service</a>
</li>
            
<li >
    <a href="../getting-started-with-systemd/">Using systemd to manage Docker containers</a>
</li>
            
<li >
    <a href="../using-systemd-and-udev-rules/">Using systemd and udev rules</a>
</li>
            
<li >
    <a href="../switching-channels/">Switching release channels</a>
</li>
            
<li >
    <a href="../scheduling-tasks-with-systemd-timers/">Scheduling tasks with systemd</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Securing Clusters</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="./">Customizing the SSH daemon</a>
</li>
            
<li >
    <a href="../sssd/">Configuring SSSD on Flatcar Container Linux</a>
</li>
            
<li >
    <a href="../hardening-guide/">Hardening a Flatcar Container Linux machine</a>
</li>
            
<li >
    <a href="../trusted-computing-hardware-requirements/">Trusted Computing Hardware Requirements</a>
</li>
            
<li >
    <a href="../adding-certificate-authorities/">Adding Cert Authorities</a>
</li>
            
<li >
    <a href="../selinux/">Using SELinux</a>
</li>
            
<li >
    <a href="../disabling-smt/">Disabling SMT</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Debugging Clusters</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../install-debugging-tools/">Install debugging tools</a>
</li>
            
<li >
    <a href="../btrfs-troubleshooting/">Working with btrfs</a>
</li>
            
<li >
    <a href="../reading-the-system-log/">Reading the system log</a>
</li>
            
<li >
    <a href="../collecting-crash-logs/">Collecting crash logs</a>
</li>
            
<li >
    <a href="../manual-rollbacks/">Manual Flatcar Container Linux rollbacks</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                                
  <li class="dropdown-submenu">
    <a href="#">Container Runtimes</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">Docker</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../getting-started-with-docker/">Getting started with Docker</a>
</li>
            
<li >
    <a href="../customizing-docker/">Customizing Docker</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                            </ul>
                        </li>
                <!--Only display pages not under the hidden tag in mkdocs.yml-->
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="../customizing-docker/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../developer-guides/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#customizing-the-ssh-daemon">Customizing the SSH daemon</a></li>
            <li><a href="#customizing-sshd-with-a-container-linux-config">Customizing sshd with a Container Linux Config</a></li>
            <li><a href="#customizing-sshd-after-first-boot">Customizing sshd after first boot</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="customizing-the-ssh-daemon">Customizing the SSH daemon<a class="headerlink" href="#customizing-the-ssh-daemon" title="Permanent link">&para;</a></h1>
<p>Flatcar Container Linux defaults to running an OpenSSH daemon using <code class="codehilite">systemd</code> socket activation -- when a client connects to the port configured for SSH, <code class="codehilite">sshd</code> is started on the fly for that client using a <code class="codehilite">systemd</code> unit derived automatically from a template. In some cases you may want to customize this daemon's authentication methods or other configuration. This guide will show you how to do that at boot time using a <a href="../provisioning/">Container Linux Config</a>, and after building by modifying the <code class="codehilite">systemd</code> unit file.</p>
<p>As a practical example, when a client fails to connect by not completing the TCP connection (e.g. because the "client" is actually a TCP port scanner), the MOTD may report failures of <code class="codehilite">systemd</code> units (which will be named by the source IP that failed to connect) next time you log in to the Flatcar Container Linux host. These failures are not themselves harmful, but it is a good general practice to change how SSH listens, either by changing the IP address <code class="codehilite">sshd</code> listens to from the default setting (which listens on all configured interfaces), changing the default port, or both.</p>
<h2 id="customizing-sshd-with-a-container-linux-config">Customizing sshd with a Container Linux Config<a class="headerlink" href="#customizing-sshd-with-a-container-linux-config" title="Permanent link">&para;</a></h2>
<p>In this example we will disable logins for the <code class="codehilite">root</code> user, only allow login for the <code class="codehilite">core</code> user and disable password based authentication. For more details on what sections can be added to <code class="codehilite">/etc/ssh/sshd_config</code> see the <a href="http://www.openssh.com/cgi-bin/man.cgi?query=sshd_config">OpenSSH manual</a>.
If you're interested in additional security options, Mozilla provides a well-commented example of a <a href="https://wiki.mozilla.org/Security/Guidelines/OpenSSH#Modern_.28OpenSSH_6.7.2B.29">hardened configuration</a>.</p>
<pre class="codehilite"><code class="language-yaml">storage:
  files:
    - path: /etc/ssh/sshd_config
      filesystem: root
      mode: 0600
      contents:
        inline: |
          # Use most defaults for sshd configuration.
          UsePrivilegeSeparation sandbox
          Subsystem sftp internal-sftp
          UseDNS no

          PermitRootLogin no
          AllowUsers core
          AuthenticationMethods publickey</code></pre>

<h3 id="changing-the-sshd-port">Changing the sshd port<a class="headerlink" href="#changing-the-sshd-port" title="Permanent link">&para;</a></h3>
<p>Flatcar Container Linux ships with socket-activated SSH daemon by default. The configuration for this can be found at <code class="codehilite">/usr/lib/systemd/system/sshd.socket</code>. We're going to override some of the default settings for this in the Container Linux Config provided at boot:</p>
<pre class="codehilite"><code class="language-yaml">systemd:
  units:
    - name: sshd.socket
      dropins:
      - name: 10-sshd-port.conf
        contents: |
          [Socket]
          ListenStream=
          ListenStream=222</code></pre>

<p><code class="codehilite">sshd</code> will now listen only on port 222 on all interfaces when the system is built.</p>
<h3 id="disabling-socket-activation-for-sshd">Disabling socket activation for sshd<a class="headerlink" href="#disabling-socket-activation-for-sshd" title="Permanent link">&para;</a></h3>
<p>It may be desirable to disable socket-activation for sshd to ensure it will reliably accept connections even when systemd or dbus aren't operating correctly.</p>
<p>To configure sshd on Flatcar Container Linux without socket activation, a Container Linux Config file similar to the following may be used:</p>
<pre class="codehilite"><code class="language-yaml">systemd:
  units:
  - name: sshd.service
    enable: true
  - name: sshd.socket
    mask: true</code></pre>

<p>Note that in this configuration the port will be configured by updating the <code class="codehilite">/etc/ssh/sshd_config</code> file with the <code class="codehilite">Port</code> directive rather than via <code class="codehilite">sshd.socket</code>.</p>
<h3 id="further-reading">Further reading<a class="headerlink" href="#further-reading" title="Permanent link">&para;</a></h3>
<p>Read the <a href="../provisioning/">full Container Linux Config</a> guide for more details on working with Container Linux Configs, including setting user's ssh keys.</p>
<h2 id="customizing-sshd-after-first-boot">Customizing sshd after first boot<a class="headerlink" href="#customizing-sshd-after-first-boot" title="Permanent link">&para;</a></h2>
<p>Since <a href="../provisioning/">Container Linux Configs</a> are only applied on first boot, existing machines will have to be configured in a different way.</p>
<p>The following sections walk through applying the same changes documented above on a running machine.</p>
<p><em>Note</em>: To avoid incidentally locking yourself out of the machine, it's a good idea to double-check you're able to directly login to the machine's console, if applicable.</p>
<h3 id="customizing-sshd95config">Customizing sshd_config<a class="headerlink" href="#customizing-sshd95config" title="Permanent link">&para;</a></h3>
<p>Since <code class="codehilite">/etc/ssh/sshd_config</code> is a symlink to a read only file in <code class="codehilite">/usr</code>, it
needs to be replaced with a regular file before it may be edited.</p>
<p>This, for example, can be done by running <code class="codehilite">sudo sed -i '' /etc/ssh/sshd_config</code>.</p>
<p>At this point, any configuration changes can easily be applied by editing the file <code class="codehilite">/etc/ssh/sshd_config</code>.</p>
<h3 id="changing-the-sshd-port_1">Changing the sshd port<a class="headerlink" href="#changing-the-sshd-port_1" title="Permanent link">&para;</a></h3>
<p>The sshd.socket unit may be configured via systemd <a href="../using-systemd-drop-in-units/">dropins</a>.</p>
<p>To change how sshd listens, update the list of <code class="codehilite">ListenStream</code>s in the <code class="codehilite">[Socket]</code> section of the dropin.</p>
<p><em>Note</em>: <code class="codehilite">ListenStream</code> is a list of values with each line adding to the list. An empty value clears the list, which is why <code class="codehilite">ListenStream=</code> is necessary to prevent it from <em>also</em> listening on the default port <code class="codehilite">22</code>.</p>
<p>To change just the listened-to port (in this example, port 222), create a dropin at <code class="codehilite">/etc/systemd/system/sshd.socket.d/10-sshd-listen-ports.conf</code></p>
<pre class="codehilite"><code># /etc/systemd/system/sshd.socket.d/10-sshd-listen-ports.conf
[Socket]
ListenStream=
ListenStream=222</code></pre>

<p>To change the listened-to IP address (in this example, 10.20.30.40):</p>
<pre class="codehilite"><code># /etc/systemd/system/sshd.socket.d/10-sshd-listen-ports.conf
[Socket]
ListenStream=
ListenStream=10.20.30.40:22
FreeBind=true</code></pre>

<p>You can specify both an IP and an alternate port in a single <code class="codehilite">ListenStream</code> line. IPv6 address bindings would be specified using the format <code class="codehilite">[2001:db8::7]:22</code>.</p>
<p><em>Note</em>: While specifying an IP address is optional, you must always specify the port, even if it is the default SSH port. The <code class="codehilite">FreeBind</code> option is used to allow the socket to be bound on addresses that are not yet configured on an interface, to avoid issues caused by delays in IP configuration at boot. (This option is required only if you are specifying an address.)</p>
<p>Multiple ListenStream lines can be specified, in which case <code class="codehilite">sshd</code> will listen on all the specified sockets:</p>
<pre class="codehilite"><code># /etc/systemd/system/sshd.socket.d/10-sshd-listen-ports.conf
[Socket]
ListenStream=
ListenStream=222
ListenStream=10.20.30.40:223
FreeBind=true</code></pre>

<h3 id="activating-changes">Activating changes<a class="headerlink" href="#activating-changes" title="Permanent link">&para;</a></h3>
<p>After creating the dropin file, the changes can be activated by doing a daemon-reload and restarting <code class="codehilite">sshd.socket</code></p>
<pre class="codehilite"><code>$ sudo systemctl daemon-reload
$ sudo systemctl restart sshd.socket</code></pre>

<p>We now see that systemd is listening on the new sockets:</p>
<pre class="codehilite"><code>$ systemctl status sshd.socket
● sshd.socket - OpenSSH Server Socket
   Loaded: loaded (/etc/systemd/system/sshd.socket; disabled; vendor preset: disabled)
   Active: active (listening) since Wed 2015-10-14 21:04:31 UTC; 2min 45s ago
   Listen: [::]:222 (Stream)
           10.20.30.40:223 (Stream)
 Accepted: 1; Connected: 0
...</code></pre>

<p>And if we attempt to connect to port 22 on our public IP, the connection is rejected, but port 222 works:</p>
<pre class="codehilite"><code>$ ssh core@[public IP]
ssh: connect to host [public IP] port 22: Connection refused
$ ssh -p 222 core@[public IP]
Flatcar Container Linux by Kinvolk stable (1353.8.0)
core@machine $</code></pre>

<h3 id="disabling-socket-activation-for-sshd_1">Disabling socket-activation for sshd<a class="headerlink" href="#disabling-socket-activation-for-sshd_1" title="Permanent link">&para;</a></h3>
<p>Simply mask the systemd.socket unit:</p>
<pre class="codehilite"><code># systemctl mask --now sshd.socket</code></pre>

<p>Finally, restart the sshd.service unit:</p>
<pre class="codehilite"><code># systemctl restart sshd.service</code></pre>

<h3 id="further-reading-on-systemd-units">Further reading on systemd units<a class="headerlink" href="#further-reading-on-systemd-units" title="Permanent link">&para;</a></h3>
<p>For more information about configuring Flatcar Container Linux hosts with <code class="codehilite">systemd</code>, see <a href="../getting-started-with-systemd/">Getting Started with systemd</a>.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '../..';</script>
        <script src="../../js/base.js"></script>
        <script src="../../search/require.js"></script>
        <script src="../../search/search.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td><kbd>&larr;</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td><kbd>&rarr;</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>


    </body>
</html>
