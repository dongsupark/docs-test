<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Running Flatcar Container Linux on libvirt - Flatcar Container Linux Documentation</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../..">Flatcar Container Linux Documentation</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                <!--Only display pages not under the hidden tag in mkdocs.yml-->
                        <li >
                            <a href="../..">Home</a>
                        </li>
                <!--Only display pages not under the hidden tag in mkdocs.yml-->
                        <li >
                            <a href="../quickstart/">Quick start</a>
                        </li>
                <!--Only display pages not under the hidden tag in mkdocs.yml-->
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Navigation <b class="caret"></b></a>
                            <ul class="dropdown-menu">
                                
  <li class="dropdown-submenu">
    <a href="#">Provisioning</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../provisioning/">Using Container Linux Config</a>
</li>
            
<li >
    <a href="../../container-linux-config-transpiler/doc/overview/">Using Config Transpiler</a>
</li>
            
<li >
    <a href="../../container-linux-config-transpiler/doc/dynamic-data/">CL Config Dynamic Data</a>
</li>
            
<li >
    <a href="../../container-linux-config-transpiler/doc/examples/">CL Config Examples</a>
</li>
            
<li >
    <a href="../../container-linux-config-transpiler/doc/configuration/">CL Config Spec</a>
</li>
    </ul>
  </li>
                                
  <li class="dropdown-submenu">
    <a href="#">Cloud Providers</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../booting-on-ec2/">Amazon EC2</a>
</li>
            
<li >
    <a href="../booting-on-azure/">Azure</a>
</li>
            
<li >
    <a href="../booting-on-digitalocean/">Digital Ocean</a>
</li>
            
<li >
    <a href="../booting-on-google-compute-engine/">Google Compute Engine</a>
</li>
            
<li >
    <a href="../booting-with-qemu/">QEMU</a>
</li>
    </ul>
  </li>
                                
  <li class="dropdown-submenu">
    <a href="#">Bare Metal</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../booting-with-ipxe/">Booting with iPXE</a>
</li>
            
<li >
    <a href="../booting-with-pxe/">Booting with PXE</a>
</li>
            
<li >
    <a href="../installing-to-disk/">Installing to Disk</a>
</li>
            
<li >
    <a href="../booting-with-iso/">Booting from ISO</a>
</li>
            
<li >
    <a href="../root-filesystem-placement/">Root filesystem placement</a>
</li>
    </ul>
  </li>
                                
  <li class="dropdown-submenu">
    <a href="#">Migrating from CoreOS Container Linux</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../migrate-from-container-linux/">Migrating from CoreOS Container Linux</a>
</li>
            
<li >
    <a href="../update-from-container-linux/">Updating from CoreOS Container Linux</a>
</li>
    </ul>
  </li>
                                
  <li class="dropdown-submenu">
    <a href="#">Working with Clusters</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">Creating Clusters</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../cluster-architectures/">Cluster architectures</a>
</li>
            
<li >
    <a href="../update-strategies/">Update strategies</a>
</li>
            
<li >
    <a href="../cluster-discovery/">Clustering machines</a>
</li>
            
<li >
    <a href="../verify-images/">Verify Flatcar Container Linux Images with GPG</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Customizing Clusters</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../network-config-with-networkd/">Using networkd to customize networking</a>
</li>
            
<li >
    <a href="../using-systemd-drop-in-units/">Using systemd drop-in units</a>
</li>
            
<li >
    <a href="../using-environment-variables-in-systemd-units/">Using environment variables in systemd units</a>
</li>
            
<li >
    <a href="../configuring-dns/">Configuring DNS</a>
</li>
            
<li >
    <a href="../configuring-date-and-timezone/">Configuring date & timezone</a>
</li>
            
<li >
    <a href="../adding-users/">Adding users</a>
</li>
            
<li >
    <a href="../other-settings/">Kernel modules / sysctl parameters</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Scaling Clusters</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../adding-disk-space/">Adding disk space</a>
</li>
            
<li >
    <a href="../mounting-storage/">Mounting storage</a>
</li>
            
<li >
    <a href="../power-management/">Power management</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Managing Clusters</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../registry-authentication/">Registry authentication</a>
</li>
            
<li >
    <a href="../iscsi/">iSCSI configuration</a>
</li>
            
<li >
    <a href="../adding-swap/">Adding swap</a>
</li>
            
<li >
    <a href="../booting-on-ecs/">Amazon EC2 Container Service</a>
</li>
            
<li >
    <a href="../getting-started-with-systemd/">Using systemd to manage Docker containers</a>
</li>
            
<li >
    <a href="../using-systemd-and-udev-rules/">Using systemd and udev rules</a>
</li>
            
<li >
    <a href="../switching-channels/">Switching release channels</a>
</li>
            
<li >
    <a href="../scheduling-tasks-with-systemd-timers/">Scheduling tasks with systemd</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Securing Clusters</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../customizing-sshd/">Customizing the SSH daemon</a>
</li>
            
<li >
    <a href="../sssd/">Configuring SSSD on Flatcar Container Linux</a>
</li>
            
<li >
    <a href="../hardening-guide/">Hardening a Flatcar Container Linux machine</a>
</li>
            
<li >
    <a href="../trusted-computing-hardware-requirements/">Trusted Computing Hardware Requirements</a>
</li>
            
<li >
    <a href="../adding-certificate-authorities/">Adding Cert Authorities</a>
</li>
            
<li >
    <a href="../selinux/">Using SELinux</a>
</li>
            
<li >
    <a href="../disabling-smt/">Disabling SMT</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Debugging Clusters</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../install-debugging-tools/">Install debugging tools</a>
</li>
            
<li >
    <a href="../btrfs-troubleshooting/">Working with btrfs</a>
</li>
            
<li >
    <a href="../reading-the-system-log/">Reading the system log</a>
</li>
            
<li >
    <a href="../collecting-crash-logs/">Collecting crash logs</a>
</li>
            
<li >
    <a href="../manual-rollbacks/">Manual Flatcar Container Linux rollbacks</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                                
  <li class="dropdown-submenu">
    <a href="#">Container Runtimes</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">Docker</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../getting-started-with-docker/">Getting started with Docker</a>
</li>
            
<li >
    <a href="../customizing-docker/">Customizing Docker</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                            </ul>
                        </li>
                <!--Only display pages not under the hidden tag in mkdocs.yml-->
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="../booting-with-iso/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../booting-with-pxe/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#running-flatcar-container-linux-on-libvirt">Running Flatcar Container Linux on libvirt</a></li>
            <li><a href="#download-the-flatcar-container-linux-image">Download the Flatcar Container Linux image</a></li>
            <li><a href="#virtual-machine-configuration">Virtual machine configuration</a></li>
            <li><a href="#virtual-machine-startup">Virtual machine startup</a></li>
            <li><a href="#using-flatcar-container-linux">Using Flatcar Container Linux</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="running-flatcar-container-linux-on-libvirt">Running Flatcar Container Linux on libvirt<a class="headerlink" href="#running-flatcar-container-linux-on-libvirt" title="Permanent link">&para;</a></h1>
<p>This guide explains how to run Flatcar Container Linux with libvirt using the QEMU driver. The libvirt configuration
file can be used (for example) with <code class="codehilite">virsh</code> or <code class="codehilite">virt-manager</code>. The guide assumes
that you already have a running libvirt setup and <code class="codehilite">virt-install</code> tool. If you
don’t have that, other solutions are most likely easier.</p>
<p>You can direct questions to the <a href="irc://irc.freenode.org:6667/#flatcar">IRC channel</a> or <a href="https://groups.google.com/forum/#!forum/flatcar-linux-dev">mailing list</a>.</p>
<h2 id="download-the-flatcar-container-linux-image">Download the Flatcar Container Linux image<a class="headerlink" href="#download-the-flatcar-container-linux-image" title="Permanent link">&para;</a></h2>
<p>In this guide, the example virtual machine we are creating is called flatcar-linux1 and
all files are stored in <code class="codehilite">/var/lib/libvirt/images/flatcar-linux</code>. This is not a requirement — feel free
to substitute that path if you use another one.</p>
<h3 id="choosing-a-channel">Choosing a channel<a class="headerlink" href="#choosing-a-channel" title="Permanent link">&para;</a></h3>
<p>Flatcar Container Linux is designed to be updated automatically with different schedules per channel. You can <a href="../update-strategies/">disable this feature</a>, although we don't recommend it. Read the <a href="https://flatcar-linux.org/releases">release notes</a> for specific features and bug fixes.</p>
<div id="libvirt-create">
  <ul class="nav nav-tabs">
    <li class="active"><a href="#stable-create" data-toggle="tab">Stable Channel</a></li>
    <li><a href="#beta-create" data-toggle="tab">Beta Channel</a></li>
    <li><a href="#alpha-create" data-toggle="tab">Alpha Channel</a></li>
    <li><a href="#edge-create" data-toggle="tab">Edge Channel</a></li>
  </ul>
  <div class="tab-content coreos-docs-image-table">
    <div class="tab-pane" id="alpha-create">
      <p>The Alpha channel closely tracks master and is released frequently. The newest versions of system libraries and utilities will be available for testing. The current version is Flatcar Container Linux 2430.0.0.</p>
      <p>We start by downloading the most recent disk image:</p>
      <pre>
mkdir -p /var/lib/libvirt/images/flatcar-linux
cd /var/lib/libvirt/images/flatcar-linux
wget https://alpha.release.flatcar-linux.net/amd64-usr/current/flatcar_production_qemu_image.img.bz2{,.sig}
gpg --verify flatcar_production_qemu_image.img.bz2.sig
bunzip2 flatcar_production_qemu_image.img.bz2</pre>
    </div>
    <div class="tab-pane" id="beta-create">
      <p>The Beta channel consists of promoted Alpha releases. The current version is Flatcar Container Linux 2411.1.0.</p>
      <p>We start by downloading the most recent disk image:</p>
      <pre>
mkdir -p /var/lib/libvirt/images/flatcar-linux
cd /var/lib/libvirt/images/flatcar-linux
wget https://beta.release.flatcar-linux.net/amd64-usr/current/flatcar_production_qemu_image.img.bz2{,.sig}
gpg --verify flatcar_production_qemu_image.img.bz2.sig
bunzip2 flatcar_production_qemu_image.img.bz2</pre>
    </div>
    <div class="tab-pane" id="edge-create">
      <p>The Edge channel includes bleeding-edge features with the newest versions of the Linux kernel, systemd and other core packages. Can be highly unstable. The current version is Flatcar Container Linux 2430.99.0.</p>
      <p>We start by downloading the most recent disk image:</p>
      <pre>
mkdir -p /var/lib/libvirt/images/flatcar-linux
cd /var/lib/libvirt/images/flatcar-linux
wget https://edge.release.flatcar-linux.net/amd64-usr/current/flatcar_production_qemu_image.img.bz2{,.sig}
gpg --verify flatcar_production_qemu_image.img.bz2.sig
bunzip2 flatcar_production_qemu_image.img.bz2</pre>
    </div>
    <div class="tab-pane active" id="stable-create">
      <p>The Stable channel should be used by production clusters. Versions of Flatcar Container Linux are battle-tested within the Beta and Alpha channels before being promoted. The current version is Flatcar Container Linux 2345.3.0.</p>
      <p>We start by downloading the most recent disk image:</p>
      <pre>
mkdir -p /var/lib/libvirt/images/flatcar-linux
cd /var/lib/libvirt/images/flatcar-linux
wget https://stable.release.flatcar-linux.net/amd64-usr/current/flatcar_production_qemu_image.img.bz2{,.sig}
gpg --verify flatcar_production_qemu_image.img.bz2.sig
bunzip2 flatcar_production_qemu_image.img.bz2</pre>
    </div>
  </div>
</div>

<h2 id="virtual-machine-configuration">Virtual machine configuration<a class="headerlink" href="#virtual-machine-configuration" title="Permanent link">&para;</a></h2>
<p>Now create a qcow2 image snapshot using the command below:</p>
<pre class="codehilite"><code class="language-sh">cd /var/lib/libvirt/images/flatcar-linux
qemu-img create -f qcow2 -b flatcar_production_qemu_image.img flatcar-linux1.qcow2</code></pre>

<p>This will create a <code class="codehilite">flatcar-linux1.qcow2</code> snapshot image. Any changes to <code class="codehilite">flatcar-linux1.qcow2</code> will not be reflected in <code class="codehilite">flatcar_production_qemu_image.img</code>. Making any changes to a base image (<code class="codehilite">flatcar_production_qemu_image.img</code> in our example) will corrupt its snapshots.</p>
<h3 id="ignition-config">Ignition config<a class="headerlink" href="#ignition-config" title="Permanent link">&para;</a></h3>
<p>The preferred way to configure a Flatcar Container Linux machine is via Ignition.
Unfortunately, libvirt does not have direct support for Ignition yet, so configuring it involves including qemu-specific xml.</p>
<p>This configuration can be done in the following steps:</p>
<h4 id="create-the-ignition-config">Create the Ignition config<a class="headerlink" href="#create-the-ignition-config" title="Permanent link">&para;</a></h4>
<p>Typically you won't write Ignition files yourself, rather you will typically use a tool like the <a href="https://coreos.com/os/docs/latest/overview-of-ct.html">config transpiler</a> to generate them.</p>
<p>However the Ignition file is created, it should be placed in a location which qemu can access. In this example, we'll place it in <code class="codehilite">/var/lib/libvirt/flatcar-linux/flatcar-linux1/provision.ign</code>.</p>
<pre class="codehilite"><code class="language-sh">mkdir -p /var/lib/libvirt/flatcar-linux/flatcar-linux1/
echo '{&quot;ignition&quot;:{&quot;version&quot;:&quot;2.0.0&quot;}}' &gt; /var/lib/libvirt/flatcar-linux/flatcar-linux1/provision.ign</code></pre>

<p>If the host uses SELinux, allow the VM access to the config:</p>
<pre class="codehilite"><code class="language-sh">semanage fcontext -a -t virt_content_t &quot;/var/lib/libvirt/flatcar-linux/flatcar-linux1&quot;
restorecon -R &quot;/var/lib/libvirt/flatcar-linux/flatcar-linux1&quot;</code></pre>

<p>A simple Flatcar Container Linux config to add your ssh keys might look like the following:</p>
<pre class="codehilite"><code class="language-yaml">storage:
  files:
  - path: /etc/hostname
    filesystem: &quot;root&quot;
    contents:
      inline: &quot;flatcar-linux1&quot;

passwd:
  users:
    - name: core
      ssh_authorized_keys:
        - &quot;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC0g+ZTxC7weoIJLUafOgrm+h...&quot;</code></pre>

<h4 id="creating-the-domain-xml">Creating the domain xml<a class="headerlink" href="#creating-the-domain-xml" title="Permanent link">&para;</a></h4>
<p>Once the Ignition file exists on disk, the machine can be configured to use it.</p>
<p>Start by creating a libvirt <a href="https://libvirt.org/formatdomaincaps.html">domain XML</a> document:</p>
<pre class="codehilite"><code class="language-sh">virt-install --connect qemu:///system \
             --import \
             --name flatcar-linux1 \
             --ram 1024 --vcpus 1 \
             --os-type=linux \
             --os-variant=virtio26 \
             --disk path=/var/lib/libvirt/images/flatcar-linux/flatcar-linux1.qcow2,format=qcow2,bus=virtio \
             --vnc --noautoconsole \
             --print-xml &gt; /var/lib/libvirt/flatcar-linux/flatcar-linux1/domain.xml</code></pre>

<p>Next, modify the domain xml to reference the qemu-specific configuration needed:</p>
<pre class="codehilite"><code class="language-xml">&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;domain xmlns:qemu=&quot;http://libvirt.org/schemas/domain/qemu/1.0&quot; type=&quot;kvm&quot;&gt;
  ...
  &lt;qemu:commandline&gt;
    &lt;qemu:arg value=&quot;-fw_cfg&quot;/&gt;
    &lt;qemu:arg value=&quot;name=opt/org.flatcar-linux/config,file=/var/lib/libvirt/flatcar-linux/flatcar-linux1/provision.ign&quot;/&gt;
  &lt;/qemu:commandline&gt;
&lt;/domain&gt;</code></pre>

<p>If you have the <code class="codehilite">xmlstarlet</code> utility installed, the above modification can be accomplished easily with the following:</p>
<pre class="codehilite"><code class="language-sh">domain=/var/lib/libvirt/flatcar-linux/flatcar-linux1/domain.xml
ignition_file=/var/lib/libvirt/flatcar-linux/flatcar-linux1/provision.ign

xmlstarlet ed -P -L -i &quot;//domain&quot; -t attr -n &quot;xmlns:qemu&quot; --value &quot;http://libvirt.org/schemas/domain/qemu/1.0&quot; &quot;${domain}&quot;
xmlstarlet ed -P -L -s &quot;//domain&quot; -t elem -n &quot;qemu:commandline&quot; &quot;${domain}&quot;
xmlstarlet ed -P -L -s &quot;//domain/qemu:commandline&quot; -t elem -n &quot;qemu:arg&quot; &quot;${domain}&quot;
xmlstarlet ed -P -L -s &quot;(//domain/qemu:commandline/qemu:arg)[1]&quot; -t attr -n &quot;value&quot; -v &quot;-fw_cfg&quot; &quot;${domain}&quot;
xmlstarlet ed -P -L -s &quot;//domain/qemu:commandline&quot; -t elem -n &quot;qemu:arg&quot; &quot;${domain}&quot;
xmlstarlet ed -P -L -s &quot;(//domain/qemu:commandline/qemu:arg)[2]&quot; -t attr -n &quot;value&quot; -v &quot;name=opt/org.flatcar-linux/config,file=${ignition_file}&quot; &quot;${domain}&quot;</code></pre>

<p>Alternately, you can accomplish the same modification using sed:</p>
<pre class="codehilite"><code class="language-sh">domain=/var/lib/libvirt/flatcar-linux/flatcar-linux1/domain.xml
ignition_file=/var/lib/libvirt/flatcar-linux/flatcar-linux1/provision.ign

sed -i 's|type=&quot;kvm&quot;|type=&quot;kvm&quot; xmlns:qemu=&quot;http://libvirt.org/schemas/domain/qemu/1.0&quot;|' &quot;${domain}&quot;
sed -i &quot;/&lt;\/devices&gt;/a &lt;qemu:commandline&gt;\n  &lt;qemu:arg value='-fw_cfg'/&gt;\n  &lt;qemu:arg value='name=opt/org.flatcar-linux/config,file=${ignition_file}'/&gt;\n&lt;/qemu:commandline&gt;&quot; &quot;${domain}&quot;</code></pre>

<h4 id="define-and-start-the-machine">Define and start the machine<a class="headerlink" href="#define-and-start-the-machine" title="Permanent link">&para;</a></h4>
<p>Once the XML domain has been edited to include the Ignition file, it can be created and started using the <code class="codehilite">virsh</code> tool included with libvirt:</p>
<pre class="codehilite"><code class="language-sh">virsh define /var/lib/libvirt/flatcar-linux/flatcar-linux1/domain.xml
virsh start flatcar-linux1 </code></pre>

<h4 id="ssh-into-the-machine">SSH into the machine<a class="headerlink" href="#ssh-into-the-machine" title="Permanent link">&para;</a></h4>
<p>By default, libvirt runs its own DHCP server which will provide an IP address to new instances. You can query it for what IP addresses have been assigned to machines:</p>
<pre class="codehilite"><code class="language-sh">$ virsh net-dhcp-leases default
Expiry Time          MAC address        Protocol  IP address                Hostname        Client ID or DUID
-------------------------------------------------------------------------------------------------------------------
 2017-08-09 16:32:52  52:54:00:13:12:45  ipv4      192.168.122.184/24        flatcar-linux1 ff:32:39:f9:b5:00:02:00:00:ab:11:06:6a:55:ed:5d:0a:73:ee</code></pre>

<h3 id="network-configuration">Network configuration<a class="headerlink" href="#network-configuration" title="Permanent link">&para;</a></h3>
<h4 id="static-ip">Static IP<a class="headerlink" href="#static-ip" title="Permanent link">&para;</a></h4>
<p>By default, Flatcar Container Linux uses DHCP to get its network configuration. In this example the VM will be attached directly to the local network via a bridge on the host's virbr0 and the local network. To configure a static address add a <a href="http://www.freedesktop.org/software/systemd/man/systemd.network.html">networkd unit</a> to the Flatcar Container Linux config:</p>
<pre class="codehilite"><code class="language-yaml">passwd:
  users:
  - name: core
    ssh_authorized_keys:
    - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDGdByTgSVHq.......

storage:
  files:
  - path: /etc/hostname
    filesystem: &quot;root&quot;
    contents: 
      inline: flatcar-linux1

networkd:
  units:
  - name: 10-ens3.network
    contents: |
      [Match]
      MACAddress=52:54:00:fe:b3:c0

      [Network]
      Address=192.168.122.2
      Gateway=192.168.122.1
      DNS=8.8.8.8</code></pre>

<h4 id="using-dhcp-with-a-libvirt-network">Using DHCP with a libvirt network<a class="headerlink" href="#using-dhcp-with-a-libvirt-network" title="Permanent link">&para;</a></h4>
<p>An alternative to statically configuring an IP at the host level is to do so at the libvirt level. If you're using libvirt's built in DHCP server and a recent libvirt version, it allows configuring what IP address will be provided to a given machine ahead of time.</p>
<p>This can be done using the <code class="codehilite">net-update</code> command. The following assumes you're using the <code class="codehilite">default</code> libvirt network and have configured the MAC Address to <code class="codehilite">52:54:00:fe:b3:c0</code> through the <code class="codehilite">--network</code> flag on <code class="codehilite">virt-install</code>:</p>
<pre class="codehilite"><code class="language-sh">ip=&quot;192.168.122.2&quot;
mac=&quot;52:54:00:fe:b3:c0&quot;

virsh net-update --network &quot;default&quot; add-last ip-dhcp-host \
    --xml &quot;&lt;host mac='${mac}' ip='${ip}' /&gt;&quot; \
    --live --config</code></pre>

<p>By executing these commands before running <code class="codehilite">virsh start</code>, we can ensure the libvirt DHCP server will hand out a known IP.</p>
<h2 id="virtual-machine-startup">Virtual machine startup<a class="headerlink" href="#virtual-machine-startup" title="Permanent link">&para;</a></h2>
<p>Now, start this libvirt instance with the RAM, vCPU, and networking configuration defined above:</p>
<pre class="codehilite"><code class="language-sh">ignition_file=/var/lib/libvirt/flatcar-linux/flatcar-linux1/provision.ign

domain=/var/lib/libvirt/flatcar-linux/flatcar-linux1/domain.xml
ip=&quot;192.168.122.2&quot;
mac=&quot;52:54:00:fe:b3:c0&quot;

mkdir -p &quot;$(dirname &quot;${domain}&quot;)&quot;

virsh net-update --network &quot;default&quot; add-last ip-dhcp-host \
    --xml &quot;&lt;host mac='${mac}' ip='${ip}' /&gt;&quot; \
    --live --config

virt-install --connect qemu:///system --import \
  --name flatcar-linux1 \
  --ram 1024 --vcpus 1 \
  --os-type=linux \
  --os-variant=virtio26 \
  --disk path=/var/lib/libvirt/images/flatcar-linux/flatcar-linux1.qcow2,format=qcow2,bus=virtio \
  --network bridge=virbr0,mac=52:54:00:fe:b3:c0 \
  --vnc --noautoconsole \
  --print-xml &gt; /var/lib/libvirt/flatcar-linux/flatcar-linux1/domain.xml

sed -ie 's|type=&quot;kvm&quot;|type=&quot;kvm&quot; xmlns:qemu=&quot;http://libvirt.org/schemas/domain/qemu/1.0&quot;|' &quot;${domain}&quot;
sed -i &quot;/&lt;\/devices&gt;/a &lt;qemu:commandline&gt;\n  &lt;qemu:arg value='-fw_cfg'/&gt;\n  &lt;qemu:arg value='name=opt/org.flatcar-linux/config,file=${ignition_file}'/&gt;\n&lt;/qemu:commandline&gt;&quot; &quot;${domain}&quot;

virsh define /var/lib/libvirt/flatcar-linux/flatcar-linux1/domain.xml
virsh start flatcar-linux1</code></pre>

<p>Once the virtual machine has started you can log in via SSH:</p>
<pre class="codehilite"><code class="language-sh">ssh core@192.168.122.2</code></pre>

<h3 id="ssh-config">SSH Config<a class="headerlink" href="#ssh-config" title="Permanent link">&para;</a></h3>
<p>To simplify this and avoid potential host key errors in the future add the following to <code class="codehilite">~/.ssh/config</code>:</p>
<pre class="codehilite"><code class="language-ini">Host flatcar-linux1
HostName 192.168.122.2
User core
StrictHostKeyChecking no
UserKnownHostsFile /dev/null</code></pre>

<p>Now you can log in to the virtual machine with:</p>
<pre class="codehilite"><code class="language-sh">ssh flatcar-linux1</code></pre>

<h2 id="using-flatcar-container-linux">Using Flatcar Container Linux<a class="headerlink" href="#using-flatcar-container-linux" title="Permanent link">&para;</a></h2>
<p>Now that you have a machine booted it is time to play around. Check out the <a href="../quickstart/">Flatcar Container Linux Quickstart</a> guide or dig into <a href="https://docs.flatcar-linux.org">more specific topics</a>.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '../..';</script>
        <script src="../../js/base.js"></script>
        <script src="../../search/require.js"></script>
        <script src="../../search/search.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td><kbd>&larr;</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td><kbd>&rarr;</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>


    </body>
</html>
