<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Flatcar Container Linux cluster discovery - Flatcar Container Linux Documentation</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../..">Flatcar Container Linux Documentation</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                <!--Only display pages not under the hidden tag in mkdocs.yml-->
                        <li >
                            <a href="../..">Home</a>
                        </li>
                <!--Only display pages not under the hidden tag in mkdocs.yml-->
                        <li >
                            <a href="../quickstart/">Quick start</a>
                        </li>
                <!--Only display pages not under the hidden tag in mkdocs.yml-->
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Navigation <b class="caret"></b></a>
                            <ul class="dropdown-menu">
                                
  <li class="dropdown-submenu">
    <a href="#">Provisioning</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../provisioning/">Using Container Linux Config</a>
</li>
            
<li >
    <a href="../../container-linux-config-transpiler/doc/overview/">Using Config Transpiler</a>
</li>
            
<li >
    <a href="../../container-linux-config-transpiler/doc/dynamic-data/">CL Config Dynamic Data</a>
</li>
            
<li >
    <a href="../../container-linux-config-transpiler/doc/examples/">CL Config Examples</a>
</li>
            
<li >
    <a href="../../container-linux-config-transpiler/doc/configuration/">CL Config Spec</a>
</li>
    </ul>
  </li>
                                
  <li class="dropdown-submenu">
    <a href="#">Cloud Providers</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../booting-on-ec2/">Amazon EC2</a>
</li>
            
<li >
    <a href="../booting-on-azure/">Azure</a>
</li>
            
<li >
    <a href="../booting-on-digitalocean/">Digital Ocean</a>
</li>
            
<li >
    <a href="../booting-on-google-compute-engine/">Google Compute Engine</a>
</li>
            
<li >
    <a href="../booting-with-qemu/">QEMU</a>
</li>
    </ul>
  </li>
                                
  <li class="dropdown-submenu">
    <a href="#">Bare Metal</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../booting-with-ipxe/">Booting with iPXE</a>
</li>
            
<li >
    <a href="../booting-with-pxe/">Booting with PXE</a>
</li>
            
<li >
    <a href="../installing-to-disk/">Installing to Disk</a>
</li>
            
<li >
    <a href="../booting-with-iso/">Booting from ISO</a>
</li>
            
<li >
    <a href="../root-filesystem-placement/">Root filesystem placement</a>
</li>
    </ul>
  </li>
                                
  <li class="dropdown-submenu">
    <a href="#">Migrating from CoreOS Container Linux</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../migrate-from-container-linux/">Migrating from CoreOS Container Linux</a>
</li>
            
<li >
    <a href="../update-from-container-linux/">Updating from CoreOS Container Linux</a>
</li>
    </ul>
  </li>
                                
  <li class="dropdown-submenu">
    <a href="#">Working with Clusters</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">Creating Clusters</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../cluster-architectures/">Cluster architectures</a>
</li>
            
<li >
    <a href="../update-strategies/">Update strategies</a>
</li>
            
<li >
    <a href="./">Clustering machines</a>
</li>
            
<li >
    <a href="../verify-images/">Verify Flatcar Container Linux Images with GPG</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Customizing Clusters</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../network-config-with-networkd/">Using networkd to customize networking</a>
</li>
            
<li >
    <a href="../using-systemd-drop-in-units/">Using systemd drop-in units</a>
</li>
            
<li >
    <a href="../using-environment-variables-in-systemd-units/">Using environment variables in systemd units</a>
</li>
            
<li >
    <a href="../configuring-dns/">Configuring DNS</a>
</li>
            
<li >
    <a href="../configuring-date-and-timezone/">Configuring date & timezone</a>
</li>
            
<li >
    <a href="../adding-users/">Adding users</a>
</li>
            
<li >
    <a href="../other-settings/">Kernel modules / sysctl parameters</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Scaling Clusters</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../adding-disk-space/">Adding disk space</a>
</li>
            
<li >
    <a href="../mounting-storage/">Mounting storage</a>
</li>
            
<li >
    <a href="../power-management/">Power management</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Managing Clusters</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../registry-authentication/">Registry authentication</a>
</li>
            
<li >
    <a href="../iscsi/">iSCSI configuration</a>
</li>
            
<li >
    <a href="../adding-swap/">Adding swap</a>
</li>
            
<li >
    <a href="../booting-on-ecs/">Amazon EC2 Container Service</a>
</li>
            
<li >
    <a href="../getting-started-with-systemd/">Using systemd to manage Docker containers</a>
</li>
            
<li >
    <a href="../using-systemd-and-udev-rules/">Using systemd and udev rules</a>
</li>
            
<li >
    <a href="../switching-channels/">Switching release channels</a>
</li>
            
<li >
    <a href="../scheduling-tasks-with-systemd-timers/">Scheduling tasks with systemd</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Securing Clusters</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../customizing-sshd/">Customizing the SSH daemon</a>
</li>
            
<li >
    <a href="../sssd/">Configuring SSSD on Flatcar Container Linux</a>
</li>
            
<li >
    <a href="../hardening-guide/">Hardening a Flatcar Container Linux machine</a>
</li>
            
<li >
    <a href="../trusted-computing-hardware-requirements/">Trusted Computing Hardware Requirements</a>
</li>
            
<li >
    <a href="../adding-certificate-authorities/">Adding Cert Authorities</a>
</li>
            
<li >
    <a href="../selinux/">Using SELinux</a>
</li>
            
<li >
    <a href="../disabling-smt/">Disabling SMT</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Debugging Clusters</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../install-debugging-tools/">Install debugging tools</a>
</li>
            
<li >
    <a href="../btrfs-troubleshooting/">Working with btrfs</a>
</li>
            
<li >
    <a href="../reading-the-system-log/">Reading the system log</a>
</li>
            
<li >
    <a href="../collecting-crash-logs/">Collecting crash logs</a>
</li>
            
<li >
    <a href="../manual-rollbacks/">Manual Flatcar Container Linux rollbacks</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                                
  <li class="dropdown-submenu">
    <a href="#">Container Runtimes</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">Docker</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../getting-started-with-docker/">Getting started with Docker</a>
</li>
            
<li >
    <a href="../customizing-docker/">Customizing Docker</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                            </ul>
                        </li>
                <!--Only display pages not under the hidden tag in mkdocs.yml-->
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="../cluster-architectures/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../collecting-crash-logs/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#flatcar-container-linux-cluster-discovery">Flatcar Container Linux cluster discovery</a></li>
            <li><a href="#overview">Overview</a></li>
            <li><a href="#new-clusters">New clusters</a></li>
            <li><a href="#common-problems-with-cluster-discovery">Common problems with cluster discovery</a></li>
            <li><a href="#running-your-own-discovery-service">Running your own discovery service</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="flatcar-container-linux-cluster-discovery">Flatcar Container Linux cluster discovery<a class="headerlink" href="#flatcar-container-linux-cluster-discovery" title="Permanent link">&para;</a></h1>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p>Flatcar Container Linux uses etcd, a service running on each machine, to handle coordination between software running on the cluster. For a group of Flatcar Container Linux machines to form a cluster, their etcd instances need to be connected.</p>
<p>A discovery service, <a href="https://discovery.etcd.io">https://discovery.etcd.io</a>, is provided as a free service to help connect etcd instances together by storing a list of peer addresses, metadata and the initial size of the cluster under a unique address, known as the discovery URL. You can generate them very easily:</p>
<pre class="codehilite"><code>$ curl -w &quot;\n&quot; 'https://discovery.etcd.io/new?size=3'
https://discovery.etcd.io/6a28e078895c5ec737174db2419bb2f3</code></pre>

<p>The discovery URL can be provided to each Flatcar Container Linux machine via <a href="../provisioning/">Container Linux Configs</a>. The rest of this guide will explain what's happening behind the scenes, but if you're trying to get clustered as quickly as possible, all you need to do is provide a <em>fresh, unique</em> discovery token in your config.</p>
<p>Boot each one of the machines with identical Container Linux Config and they should be automatically clustered:</p>
<pre class="codehilite"><code class="language-yaml">etcd:
  # generate a new token for each unique cluster from https://discovery.etcd.io/new?size=3
  # specify the initial size of your cluster with ?size=X
  discovery: https://discovery.etcd.io/&lt;token&gt;
  # multi_region and multi_cloud deployments need to use {PUBLIC_IPV4}
  advertise_client_urls: http://{PRIVATE_IPV4}:2379,http://{PRIVATE_IPV4}:4001
  initial_advertise_peer_urls: http://{PRIVATE_IPV4}:2380
  # listen on both the official ports and the legacy ports
  # legacy ports can be omitted if your application doesn't depend on them
  listen_client_urls: http://0.0.0.0:2379,http://0.0.0.0:4001
  listen_peer_urls: http://{PRIVATE_IPV4}:2380</code></pre>

<p>Specific documentation are provided for each platform's guide. Not all providers support the <code class="codehilite">{PRIVATE_IPV4}</code> variable substitution.</p>
<h2 id="new-clusters">New clusters<a class="headerlink" href="#new-clusters" title="Permanent link">&para;</a></h2>
<p>Starting a Flatcar Container Linux cluster requires one of the new machines to become the first leader of the cluster. The initial leader is stored as metadata with the discovery URL in order to inform the other members of the new cluster. Let's walk through a timeline a new three-machine Flatcar Container Linux cluster discovering each other:</p>
<ol>
<li>All three machines are booted via a cloud-provider with the same config in the user-data.</li>
<li>Machine 1 starts up first. It requests information about the cluster from the discovery token and submits its <code class="codehilite">-initial-advertise-peer-urls</code> address <code class="codehilite">10.10.10.1</code>.</li>
<li>No state is recorded into the discovery URL metadata, so machine 1 becomes the leader and records the state as <code class="codehilite">started</code>.</li>
<li>Machine 2 boots and submits its <code class="codehilite">-initial-advertise-peer-urls</code> address <code class="codehilite">10.10.10.2</code>. It also reads back the list of existing peers (only <code class="codehilite">10.10.10.1</code>) and attempts to connect to the address listed.</li>
<li>Machine 2 connects to Machine 1 and is now part of the cluster as a follower.</li>
<li>Machine 3 boots and submits its <code class="codehilite">-initial-advertise-peer-urls</code> address <code class="codehilite">10.10.10.3</code>. It reads back the list of peers (<code class="codehilite">10.10.10.1</code> and <code class="codehilite">10.10.10.2</code>) and selects one of the addresses to try first. When it connects to a machine in the cluster, the machine is given a full list of the existing other members of the cluster.</li>
<li>The cluster is now bootstrapped with an initial leader and two followers.</li>
</ol>
<p>There are a few interesting things happening during this process.</p>
<p>First, each machine is configured with the same discovery URL and etcd figured out what to do. This allows you to load the same Container Linux Config into an auto-scaling group and it will work whether it is the first or 30<sup>th</sup> machine in the group.</p>
<p>Second, machine 3 only needed to use one of the addresses stored in the discovery URL to connect to the cluster. Since etcd uses the Raft consensus algorithm, existing machines in the cluster already maintain a list of healthy members in order for the algorithm to function properly. This list is given to the new machine and it starts normal operations with each of the other cluster members.</p>
<p>Third, if you specified <code class="codehilite">?size=3</code> upon discovery URL creation, any other machines that join the cluster in the future will automatically start as etcd proxies.</p>
<h2 id="common-problems-with-cluster-discovery">Common problems with cluster discovery<a class="headerlink" href="#common-problems-with-cluster-discovery" title="Permanent link">&para;</a></h2>
<h3 id="existing-clusters">Existing clusters<a class="headerlink" href="#existing-clusters" title="Permanent link">&para;</a></h3>
<p><a href="https://github.com/flatcar-linux/etcd/blob/master/Documentation/op-guide/runtime-reconf-design.md#do-not-use-public-discovery-service-for-runtime-reconfiguration">Do not use the public discovery service to reconfigure a running etcd cluster.</a> The public discovery service is a convenience for bootstrapping new clusters, especially on cloud providers with dynamic IP assignment, but is not designed for the later case when the cluster is running and member IPs are known.</p>
<p>To promote proxy members or join new members into an existing etcd cluster, configure static discovery and add members. The <a href="https://github.com/coreos/docs/blob/master/etcd/etcd-live-cluster-reconfiguration.md">etcd cluster reconfiguration guide</a> details the steps for performing this reconfiguration on Flatcar Container Linux systems that were originally deployed with public discovery. The more general <a href="https://github.com/flatcar-linux/etcd/blob/master/Documentation/op-guide/runtime-configuration.md">etcd cluster reconfiguration document</a> explains the operations for removing and adding cluster members in a cluster already configured with static discovery.</p>
<h3 id="stale-tokens">Stale tokens<a class="headerlink" href="#stale-tokens" title="Permanent link">&para;</a></h3>
<p>A common problem with cluster discovery is attempting to boot a new cluster with a stale discovery URL. As explained above, the initial leader election is recorded into the URL, which indicates that the new etcd instance should be joining an existing cluster.</p>
<p>If you provide a stale discovery URL, the new machines will attempt to connect to each of the old peer addresses, which will fail since they don't exist, and the bootstrapping process will fail.</p>
<p>If you're thinking, why can't the new machines just form a new cluster if they're all down. There's a really great reason for this &mdash; if an etcd peer was in a network partition, it would look exactly like the "full-down" situation and starting a new cluster would form a split-brain. Since etcd will never be able to determine whether a token has been reused or not, it must assume the worst and abort the cluster discovery.</p>
<p>If you're running into problems with your discovery URL, there are a few sources of information that can help you see what's going on. First, you can open the URL in a browser to see what information etcd is using to bootstrap itself:</p>
<pre class="codehilite"><code class="language-sh">{
  action: &quot;get&quot;,
  node: {
    key: &quot;/_etcd/registry/506f6c1bc729377252232a0121247119&quot;,
    dir: true,
    nodes: [
      {
        key: &quot;/_etcd/registry/506f6c1bc729377252232a0121247119/0d79b4791be9688332cc05367366551e&quot;,
        value: &quot;http://10.183.202.105:7001&quot;,
        expiration: &quot;2014-08-17T16:21:37.426001686Z&quot;,
        ttl: 576008,
        modifiedIndex: 72783864,
        createdIndex: 72783864
      },
      {
        key: &quot;/_etcd/registry/506f6c1bc729377252232a0121247119/c72c63ffce6680737ea2b670456aaacd&quot;,
        value: &quot;http://10.65.177.56:7001&quot;,
        expiration: &quot;2014-08-17T12:05:57.717243529Z&quot;,
        ttl: 560669,
        modifiedIndex: 72626400,
        createdIndex: 72626400
      },
      {
        key: &quot;/_etcd/registry/506f6c1bc729377252232a0121247119/f7a93d1f0cd4d318c9ad0b624afb9cf9&quot;,
        value: &quot;http://10.29.193.50:7001&quot;,
        expiration: &quot;2014-08-17T17:18:25.045563473Z&quot;,
        ttl: 579416,
        modifiedIndex: 72821950,
        createdIndex: 72821950
      }
    ],
    modifiedIndex: 69367741,
    createdIndex: 69367741
  }
}</code></pre>

<p>To rule out firewall settings as a source of your issue, ensure that you can curl each of the IPs from machines in your cluster.</p>
<p>If all of the IPs can be reached, the etcd log can provide more clues:</p>
<pre class="codehilite"><code>journalctl -u etcd-member</code></pre>

<h3 id="communicating-with-discoveryetcdio">Communicating with discovery.etcd.io<a class="headerlink" href="#communicating-with-discoveryetcdio" title="Permanent link">&para;</a></h3>
<p>If your Flatcar Container Linux cluster can't communicate out to the public internet, <a href="https://discovery.etcd.io">https://discovery.etcd.io</a> won't work and you'll have to run your own discovery endpoint, which is described below.</p>
<h3 id="setting-advertised-client-addresses-correctly">Setting advertised client addresses correctly<a class="headerlink" href="#setting-advertised-client-addresses-correctly" title="Permanent link">&para;</a></h3>
<p>Each etcd instance submits the list of <code class="codehilite">-initial-advertise-peer-urls</code> of each etcd instance to the configured discovery service. It's important to select an address that <em>all</em> peers in the cluster can communicate with. If you are configuring a list of addresses, make sure each member can communicate with at least one of the addresses.</p>
<p>For example, if you're located in two regions of a cloud provider, configuring a private <code class="codehilite">10.x</code> address will not work between the two regions, and communication will not be possible between all peers. The <code class="codehilite">-listen-client-urls</code> flag allows you to bind to a specific list of interfaces and ports (or all interfaces) to ensure your etcd traffic is routed properly.</p>
<h2 id="running-your-own-discovery-service">Running your own discovery service<a class="headerlink" href="#running-your-own-discovery-service" title="Permanent link">&para;</a></h2>
<p>The public discovery service is just an etcd cluster made available to the public internet. Since the discovery service conducts and stores the result of the first leader election, it needs to be consistent. You wouldn't want two machines in the same cluster to think they were both the leader.</p>
<p>Since etcd is designed to this type of leader election, it was an obvious choice to use it for everyone's initial leader election. This means that it's easy to run your own etcd cluster for this purpose.</p>
<p>If you're interested in how discovery API works behind the scenes in etcd, read about <a href="https://github.com/flatcar-linux/etcd/blob/master/Documentation/op-guide/clustering.md">etcd clustering</a>.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '../..';</script>
        <script src="../../js/base.js"></script>
        <script src="../../search/require.js"></script>
        <script src="../../search/search.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td><kbd>&larr;</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td><kbd>&rarr;</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>


    </body>
</html>
